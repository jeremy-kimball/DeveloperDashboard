import{Utils}from"./utils";class GridStackEngine{constructor(t={}){this.addedNodes=[],this.removedNodes=[],this.column=t.column||12,this.maxRow=t.maxRow,this._float=t.float,this.nodes=t.nodes||[],this.onChange=t.onChange}batchUpdate(t=!0,i=!0){return!!this.batchMode===t||((this.batchMode=t)?(this._prevFloat=this._float,this._float=!0,this.cleanNodes(),this.saveInitial()):(this._float=this._prevFloat,delete this._prevFloat,i&&this._packNodes(),this._notify())),this}_useEntireRowArea(t,i){return(!this.float||this.batchMode&&!this._prevFloat)&&!this._hasLocked&&(!t._moving||t._skipDown||i.y<=t.y)}_fixCollisions(i,e=i,s,o={}){if(this.sortNodes(-1),!(s=s||this.collide(i,e)))return!1;if(i._moving&&!o.nested&&!this.float&&this.swap(i,s))return!0;let t=e,h=(this._useEntireRowArea(i,e)&&(t={x:0,w:this.column,y:e.y,h:e.h},s=this.collide(i,t,o.skip)),!1);for(var n={nested:!0,pack:!1};s=s||this.collide(i,t,o.skip);){let t;if(s.locked||i._moving&&!i._skipDown&&e.y>i.y&&!this.float&&(!this.collide(s,{...s,y:i.y},i)||!this.collide(s,{...s,y:e.y-s.h},i))?(i._skipDown=i._skipDown||e.y>i.y,t=this.moveNode(i,{...e,y:s.y+s.h,...n}),s.locked&&t?Utils.copyPos(e,i):!s.locked&&t&&o.pack&&(this._packNodes(),e.y=s.y+s.h,Utils.copyPos(i,e)),h=h||t):t=this.moveNode(s,{...s,y:e.y+e.h,skip:i,...n}),!t)return h;s=void 0}return h}collide(t,i=t,e){const s=t._id,o=e?._id;return this.nodes.find(t=>t._id!==s&&t._id!==o&&Utils.isIntercepted(t,i))}collideAll(t,i=t,e){const s=t._id,o=e?._id;return this.nodes.filter(t=>t._id!==s&&t._id!==o&&Utils.isIntercepted(t,i))}directionCollideCoverage(t,i,e){if(i.rect&&t._rect){let o=t._rect,h={...i.rect};h.y>o.y?(h.h+=h.y-o.y,h.y=o.y):h.h+=o.y-h.y,h.x>o.x?(h.w+=h.x-o.x,h.x=o.x):h.w+=o.x-h.x;let n,d=.5;return e.forEach(e=>{if(!e.locked&&e._rect){var s=e._rect;let t=Number.MAX_VALUE,i=Number.MAX_VALUE;o.y<s.y?t=(h.y+h.h-s.y)/s.h:o.y+o.h>s.y+s.h&&(t=(s.y+s.h-h.y)/s.h),o.x<s.x?i=(h.x+h.w-s.x)/s.w:o.x+o.w>s.x+s.w&&(i=(s.x+s.w-h.x)/s.w);s=Math.min(i,t);s>d&&(d=s,n=e)}}),i.collide=n}}cacheRects(i,e,s,o,h,n){return this.nodes.forEach(t=>t._rect={y:t.y*e+s,x:t.x*i+n,w:t.w*i-n-o,h:t.h*e-s-h}),this}swap(e,s){if(!s||s.locked||!e||e.locked)return!1;function t(){var t=s.x,i=s.y;return s.x=e.x,s.y=e.y,e.h!=s.h?(e.x=t,e.y=s.y+s.h):(e.w!=s.w?e.x=s.x+s.w:e.x=t,e.y=i),e._dirty=s._dirty=!0}let i;if(e.w===s.w&&e.h===s.h&&(e.x===s.x||e.y===s.y)&&(i=Utils.isTouching(e,s)))return t();var o;if(!1!==i)return e.w===s.w&&e.x===s.x&&(i=i||Utils.isTouching(e,s))?(s.y<e.y&&(o=e,e=s,s=o),t()):!1!==i?!(e.h!==s.h||e.y!==s.y||!(i=i||Utils.isTouching(e,s)))&&(s.x<e.x&&(o=e,e=s,s=o),t()):void 0}isAreaEmpty(t,i,e,s){return!this.collide({x:t||0,y:i||0,w:e||1,h:s||1})}compact(o="compact",t=!0){if(0===this.nodes.length)return this;t&&this.sortNodes();var t=this.batchMode,i=(t||this.batchUpdate(),this._inColumnResize);i||(this._inColumnResize=!0);let e=this.nodes;return this.nodes=[],e.forEach((t,i,e)=>{let s;t.locked||(t.autoPosition=!0,"list"===o&&i&&(s=e[i-1])),this.addNode(t,!1,s)}),i||delete this._inColumnResize,t||this.batchUpdate(!1),this}set float(t){this._float!==t&&(this._float=t||!1,t||this._packNodes()._notify())}get float(){return this._float||!1}sortNodes(t=1,i=this.column){return this.nodes=Utils.sort(this.nodes,t,i),this}_packNodes(){return this.batchMode||(this.sortNodes(),this.float?this.nodes.forEach(i=>{if(!i._updating&&void 0!==i._orig&&i.y!==i._orig.y){let t=i.y;for(;t>i._orig.y;)--t,this.collide(i,{x:i.x,y:t,w:i.w,h:i.h})||(i._dirty=!0,i.y=t)}}):this.nodes.forEach((t,i)=>{if(!t.locked)for(;0<t.y;){var e=0===i?0:t.y-1;if(!(0===i||!this.collide(t,{x:t.x,y:e,w:t.w,h:t.h})))break;t._dirty=t.y!==e,t.y=e}})),this}prepareNode(t,i){t._id=t._id??GridStackEngine._idSeq++,void 0!==t.x&&void 0!==t.y&&null!==t.x&&null!==t.y||(t.autoPosition=!0);var e={x:0,y:0,w:1,h:1};return Utils.defaults(t,e),t.autoPosition||delete t.autoPosition,t.noResize||delete t.noResize,t.noMove||delete t.noMove,Utils.sanitizeMinMax(t),"string"==typeof t.x&&(t.x=Number(t.x)),"string"==typeof t.y&&(t.y=Number(t.y)),"string"==typeof t.w&&(t.w=Number(t.w)),"string"==typeof t.h&&(t.h=Number(t.h)),isNaN(t.x)&&(t.x=e.x,t.autoPosition=!0),isNaN(t.y)&&(t.y=e.y,t.autoPosition=!0),isNaN(t.w)&&(t.w=e.w),isNaN(t.h)&&(t.h=e.h),this.nodeBoundFix(t,i),t}nodeBoundFix(i,t){var e=i._orig||Utils.copyPos({},i),s=(i.maxW&&(i.w=Math.min(i.w,i.maxW)),i.maxH&&(i.h=Math.min(i.h,i.maxH)),i.minW&&i.minW<=this.column&&(i.w=Math.max(i.w,i.minW)),i.minH&&(i.h=Math.max(i.h,i.minH)),(i.x||0)+(i.w||1)>this.column);if(s&&this.column<12&&!this._inColumnResize&&i._id&&-1===this.findCacheLayout(i,12)){let t={...i};t.autoPosition||void 0===t.x?(delete t.x,delete t.y):t.x=Math.min(11,t.x),t.w=Math.min(12,t.w||1),this.cacheOneLayout(t,12)}return i.w>this.column?i.w=this.column:i.w<1&&(i.w=1),this.maxRow&&i.h>this.maxRow?i.h=this.maxRow:i.h<1&&(i.h=1),i.x<0&&(i.x=0),i.y<0&&(i.y=0),i.x+i.w>this.column&&(t?i.w=this.column-i.x:i.x=this.column-i.w),this.maxRow&&i.y+i.h>this.maxRow&&(t?i.h=this.maxRow-i.y:i.y=this.maxRow-i.h),Utils.samePos(i,e)||(i._dirty=!0),this}getDirtyNodes(t){return t?this.nodes.filter(t=>t._dirty&&!Utils.samePos(t,t._orig)):this.nodes.filter(t=>t._dirty)}_notify(t){if(this.batchMode||!this.onChange)return this;t=(t||[]).concat(this.getDirtyNodes());return this.onChange(t),this}cleanNodes(){return this.batchMode||this.nodes.forEach(t=>{delete t._dirty,delete t._lastTried}),this}saveInitial(){return this.nodes.forEach(t=>{t._orig=Utils.copyPos({},t),delete t._dirty}),this._hasLocked=this.nodes.some(t=>t.locked),this}restoreInitial(){return this.nodes.forEach(t=>{Utils.samePos(t,t._orig)||(Utils.copyPos(t,t._orig),t._dirty=!0)}),this._notify(),this}findEmptyPosition(e,s=this.nodes,i=this.column,o){let h=!1;for(let t=o?o.y*i+(o.x+o.w):0;!h;++t){var n=t%i,d=Math.floor(t/i);if(!(n+e.w>i)){let i={x:n,y:d,w:e.w,h:e.h};s.find(t=>Utils.isIntercepted(i,t))||(e.x===n&&e.y===d||(e._dirty=!0),e.x=n,e.y=d,delete e.autoPosition,h=!0)}}return h}addNode(i,t=!1,e){var s=this.nodes.find(t=>t._id===i._id);if(s)return s;this._inColumnResize?this.nodeBoundFix(i):this.prepareNode(i),delete i._temporaryRemoved,delete i._removeDOM;let o;return i.autoPosition&&this.findEmptyPosition(i,this.nodes,this.column,e)&&(delete i.autoPosition,o=!0),this.nodes.push(i),t&&this.addedNodes.push(i),o||this._fixCollisions(i),this.batchMode||this._packNodes()._notify(),i}removeNode(i,t=!0,e=!1){return this.nodes.find(t=>t._id===i._id)&&(e&&this.removedNodes.push(i),t&&(i._removeDOM=!0),this.nodes=this.nodes.filter(t=>t._id!==i._id),i._isAboutToRemove||this._packNodes(),this._notify([i])),this}removeAll(t=!0){return delete this._layouts,this.nodes.length?(t&&this.nodes.forEach(t=>t._removeDOM=!0),this.removedNodes=this.nodes,this.nodes=[],this._notify(this.removedNodes)):this}moveNodeCheck(i,t){if(!this.changedPosConstrain(i,t))return!1;if(t.pack=!0,!this.maxRow)return this.moveNode(i,t);let e,s=new GridStackEngine({column:this.column,float:this.float,nodes:this.nodes.map(t=>t._id===i._id?e={...t}:{...t})});if(!e)return!1;var o=s.moveNode(e,t)&&s.getRow()<=Math.max(this.getRow(),this.maxRow);if(!o&&!t.resizing&&t.collide){t=t.collide.el.gridstackNode;if(this.swap(i,t))return this._notify(),!0}return!!o&&(s.nodes.filter(t=>t._dirty).forEach(i=>{let t=this.nodes.find(t=>t._id===i._id);t&&(Utils.copyPos(t,i),t._dirty=!0)}),this._notify(),!0)}willItFit(t){if(delete t._willFitPos,!this.maxRow)return!0;let i=new GridStackEngine({column:this.column,float:this.float,nodes:this.nodes.map(t=>({...t}))}),e={...t};return this.cleanupNode(e),delete e.el,delete e._id,delete e.content,delete e.grid,i.addNode(e),i.getRow()<=this.maxRow&&(t._willFitPos=Utils.copyPos({},e),!0)}changedPosConstrain(t,i){return i.w=i.w||t.w,i.h=i.h||t.h,t.x!==i.x||t.y!==i.y||(t.maxW&&(i.w=Math.min(i.w,t.maxW)),t.maxH&&(i.h=Math.min(i.h,t.maxH)),t.minW&&(i.w=Math.max(i.w,t.minW)),t.minH&&(i.h=Math.max(i.h,t.minH)),t.w!==i.w||t.h!==i.h)}moveNode(i,e){if(!i||!e)return!1;let s;void 0!==e.pack||this.batchMode||(s=e.pack=!0),"number"!=typeof e.x&&(e.x=i.x),"number"!=typeof e.y&&(e.y=i.y),"number"!=typeof e.w&&(e.w=i.w),"number"!=typeof e.h&&(e.h=i.h);var t=i.w!==e.w||i.h!==e.h,o=Utils.copyPos({},i,!0);if(Utils.copyPos(o,e),this.nodeBoundFix(o,t),Utils.copyPos(e,o),!e.forceCollide&&Utils.samePos(i,e))return!1;var t=Utils.copyPos({},i),h=this.collideAll(i,o,e.skip);let n=!0;if(h.length){var d=i._moving&&!e.nested;let t=d?this.directionCollideCoverage(i,e,h):h[0];d&&t&&i.grid?.opts?.subGridDynamic&&!i.grid._isTemp&&(.8<Utils.areaIntercept(e.rect,t._rect)/((h=Utils.area(e.rect))<(d=Utils.area(t._rect))?h:d)&&(t.grid.makeSubGrid(t.el,void 0,i),t=void 0)),t?n=!this._fixCollisions(i,o,t,e):(n=!1,s&&delete e.pack)}return n&&(i._dirty=!0,Utils.copyPos(i,o)),e.pack&&this._packNodes()._notify(),!Utils.samePos(i,t)}getRow(){return this.nodes.reduce((t,i)=>Math.max(t,i.y+i.h),0)}beginUpdate(t){return t._updating||(t._updating=!0,delete t._skipDown,this.batchMode||this.saveInitial()),this}endUpdate(){let t=this.nodes.find(t=>t._updating);return t&&(delete t._updating,delete t._skipDown),this}save(e=!0,s){var t=this._layouts?.length;let o=t&&this.column!==t-1?this._layouts[t-1]:null,h=[];return this.sortNodes(),this.nodes.forEach(i=>{var t=o?.find(t=>t._id===i._id),t={...i,...t||{}};Utils.removeInternalForSave(t,!e),s&&s(i,t),h.push(t)}),h}layoutsNodesChange(i){return!this._layouts||this._inColumnResize||this._layouts.forEach((s,t)=>{if(!s||t===this.column)return this;if(t<this.column)this._layouts[t]=void 0;else{let e=t/this.column;i.forEach(i=>{if(i._orig){let t=s.find(t=>t._id===i._id);t&&(0<=t.y&&i.y!==i._orig.y&&(t.y+=i.y-i._orig.y),i.x!==i._orig.x&&(t.x=Math.round(i.x*e)),i.w!==i._orig.w&&(t.w=Math.round(i.w*e)))}})}}),this}columnChanged(o,h,n,t="moveScale"){if(!this.nodes.length||!h||o===h)return this;const d="compact"===t||"list"===t;d&&this.sortNodes(1,o),h<o&&this.cacheLayout(this.nodes,o),this.batchUpdate();let r=[],e=!1;if(1===h&&n?.length){e=!0;let i=0;n.forEach(t=>{t.x=0,t.w=1,t.y=Math.max(t.y,i),i=t.y+t.h}),r=n,n=[]}else n=d?this.nodes:Utils.sort(this.nodes,-1,o);if(o<h&&this._layouts){const s=this._layouts[h]||[];var i=this._layouts.length-1;!s.length&&o!==i&&this._layouts[i]?.length&&(o=i,this._layouts[i].forEach(i=>{let t=n.find(t=>t._id===i._id);t&&(d||i.autoPosition||(t.x=i.x??t.x,t.y=i.y??t.y),t.w=i.w??t.w,null!=i.x&&void 0!==i.y||(t.autoPosition=!0))})),s.forEach(i=>{var t=n.findIndex(t=>t._id===i._id);if(-1!==t){const e=n[t];d?e.w=i.w:((i.autoPosition||isNaN(i.x)||isNaN(i.y))&&this.findEmptyPosition(i,r),i.autoPosition||(e.x=i.x??e.x,e.y=i.y??e.y,e.w=i.w??e.w,r.push(e)),n.splice(t,1))}})}if(d)this.compact(t,!1);else{if(n.length)if("function"==typeof t)t(h,o,r,n);else if(!e){let i=d||"none"===t?1:h/o,e="move"===t||"moveScale"===t,s="scale"===t||"moveScale"===t;n.forEach(t=>{t.x=1===h?0:e?Math.round(t.x*i):Math.min(t.x,h-1),t.w=1===h||1===o?1:s?Math.round(t.w*i)||1:Math.min(t.w,h),r.push(t)}),n=[]}e||(r=Utils.sort(r,-1,h)),this._inColumnResize=!0,this.nodes=[],r.forEach(t=>{this.addNode(t,!1),delete t._orig})}return this.nodes.forEach(t=>delete t._orig),this.batchUpdate(!1,!d),delete this._inColumnResize,this}cacheLayout(t,i,e=!1){let s=[];return t.forEach((i,t)=>{var e;void 0===i._id&&(e=i.id?this.nodes.find(t=>t.id===i.id):void 0,i._id=e?._id??GridStackEngine._idSeq++),s[t]={x:i.x,y:i.y,w:i.w,_id:i._id}}),this._layouts=!e&&this._layouts||[],this._layouts[i]=s,this}cacheOneLayout(t,i){t._id=t._id??GridStackEngine._idSeq++;let e={x:t.x,y:t.y,w:t.w,_id:t._id};!t.autoPosition&&void 0!==t.x||(delete e.x,delete e.y,t.autoPosition&&(e.autoPosition=!0)),this._layouts=this._layouts||[],this._layouts[i]=this._layouts[i]||[];t=this.findCacheLayout(t,i);return-1===t?this._layouts[i].push(e):this._layouts[i][t]=e,this}findCacheLayout(i,t){return this._layouts?.[t]?.findIndex(t=>t._id===i._id)??-1}removeNodeFromLayoutCache(i){if(this._layouts)for(let t=0;t<this._layouts.length;t++){var e=this.findCacheLayout(i,t);-1!==e&&this._layouts[t].splice(e,1)}}cleanupNode(t){for(var i in t)"_"===i[0]&&"_id"!==i&&delete t[i];return this}}GridStackEngine._idSeq=0;export{GridStackEngine};