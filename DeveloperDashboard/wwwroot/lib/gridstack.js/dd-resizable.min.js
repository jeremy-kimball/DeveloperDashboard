import{DDResizableHandle}from"./dd-resizable-handle";import{DDBaseImplement}from"./dd-base-impl";import{Utils}from"./utils";import{DDManager}from"./dd-manager";class DDResizable extends DDBaseImplement{constructor(t,e={}){super(),this.rectScale={x:1,y:1},this._ui=()=>{const t=this.el.parentElement;var e=t.getBoundingClientRect(),i={width:this.originalRect.width,height:this.originalRect.height+this.scrolled,left:this.originalRect.left,top:this.originalRect.top-this.scrolled},i=this.temporalRect||i;return{position:{left:(i.left-e.left)*this.rectScale.x,top:(i.top-e.top)*this.rectScale.y},size:{width:i.width*this.rectScale.x,height:i.height*this.rectScale.y}}},this.el=t,this.option=e,this._mouseOver=this._mouseOver.bind(this),this._mouseOut=this._mouseOut.bind(this),this.enable(),this._setupAutoHide(this.option.autoHide),this._setupHandlers()}on(t,e){super.on(t,e)}off(t){super.off(t)}enable(){super.enable(),this.el.classList.remove("ui-resizable-disabled"),this._setupAutoHide(this.option.autoHide)}disable(){super.disable(),this.el.classList.add("ui-resizable-disabled"),this._setupAutoHide(!1)}destroy(){this._removeHandlers(),this._setupAutoHide(!1),delete this.el,super.destroy()}updateOption(e){var t=e.handles&&e.handles!==this.option.handles,i=e.autoHide&&e.autoHide!==this.option.autoHide;return Object.keys(e).forEach(t=>this.option[t]=e[t]),t&&(this._removeHandlers(),this._setupHandlers()),i&&this._setupAutoHide(this.option.autoHide),this}_setupAutoHide(t){return t?(this.el.classList.add("ui-resizable-autohide"),this.el.addEventListener("mouseover",this._mouseOver),this.el.addEventListener("mouseout",this._mouseOut)):(this.el.classList.remove("ui-resizable-autohide"),this.el.removeEventListener("mouseover",this._mouseOver),this.el.removeEventListener("mouseout",this._mouseOut),DDManager.overResizeElement===this&&delete DDManager.overResizeElement),this}_mouseOver(t){DDManager.overResizeElement||DDManager.dragElement||(DDManager.overResizeElement=this).el.classList.remove("ui-resizable-autohide")}_mouseOut(t){DDManager.overResizeElement===this&&(delete DDManager.overResizeElement,this.el.classList.add("ui-resizable-autohide"))}_setupHandlers(){let t=this.option.handles||"e,s,se";return"all"===t&&(t="n,e,s,w,se,sw,ne,nw"),this.handlers=t.split(",").map(t=>t.trim()).map(e=>new DDResizableHandle(this.el,e,{start:t=>{this._resizeStart(t)},stop:t=>{this._resizeStop(t)},move:t=>{this._resizing(t,e)}})),this}_resizeStart(t){this.originalRect=this.el.getBoundingClientRect(),this.scrollEl=Utils.getScrollElement(this.el),this.scrollY=this.scrollEl.scrollTop,this.scrolled=0,this.startEvent=t,this._setupHelper(),this._applyChange();t=Utils.initEvent(t,{type:"resizestart",target:this.el});return this.option.start&&this.option.start(t,this._ui()),this.el.classList.add("ui-resizable-resizing"),this.triggerEvent("resizestart",t),this}_resizing(t,e){this.scrolled=this.scrollEl.scrollTop-this.scrollY,this.temporalRect=this._getChange(t,e),this._applyChange();e=Utils.initEvent(t,{type:"resize",target:this.el});return this.option.resize&&this.option.resize(e,this._ui()),this.triggerEvent("resize",e),this}_resizeStop(t){t=Utils.initEvent(t,{type:"resizestop",target:this.el});return this.option.stop&&this.option.stop(t),this.el.classList.remove("ui-resizable-resizing"),this.triggerEvent("resizestop",t),this._cleanHelper(),delete this.startEvent,delete this.originalRect,delete this.temporalRect,delete this.scrollY,delete this.scrolled,this}_setupHelper(){this.elOriginStyleVal=DDResizable._originStyleProp.map(t=>this.el.style[t]),this.parentOriginStylePosition=this.el.parentElement.style.position;const t=this.el.parentElement,e=document.createElement("div");Utils.addElStyles(e,{opacity:"0",position:"fixed",top:"0px",left:"0px",width:"1px",height:"1px",zIndex:"-999999"}),t.appendChild(e);var i=e.getBoundingClientRect();return t.removeChild(e),this.rectScale={x:1/i.width,y:1/i.height},getComputedStyle(this.el.parentElement).position.match(/static/)&&(this.el.parentElement.style.position="relative"),this.el.style.position="absolute",this.el.style.opacity="0.8",this}_cleanHelper(){return DDResizable._originStyleProp.forEach((t,e)=>{this.el.style[t]=this.elOriginStyleVal[e]||null}),this.el.parentElement.style.position=this.parentOriginStylePosition||null,this}_getChange(t,e){var i=this.startEvent;const s={width:this.originalRect.width,height:this.originalRect.height+this.scrolled,left:this.originalRect.left,top:this.originalRect.top-this.scrolled};var h=t.clientX-i.clientX,t=t.clientY-i.clientY,i=(-1<e.indexOf("e")?s.width+=h:-1<e.indexOf("w")&&(s.width-=h,s.left+=h),-1<e.indexOf("s")?s.height+=t:-1<e.indexOf("n")&&(s.height-=t,s.top+=t),this._constrainSize(s.width,s.height));return Math.round(s.width)!==Math.round(i.width)&&(-1<e.indexOf("w")&&(s.left+=s.width-i.width),s.width=i.width),Math.round(s.height)!==Math.round(i.height)&&(-1<e.indexOf("n")&&(s.top+=s.height-i.height),s.height=i.height),s}_constrainSize(t,e){var i=this.option.maxWidth||Number.MAX_SAFE_INTEGER,s=this.option.minWidth/this.rectScale.x||t,h=this.option.maxHeight||Number.MAX_SAFE_INTEGER,l=this.option.minHeight/this.rectScale.y||e;return{width:Math.min(i,Math.max(s,t)),height:Math.min(h,Math.max(l,e))}}_applyChange(){let s={left:0,top:0,width:0,height:0};if("absolute"===this.el.style.position){const i=this.el.parentElement;var{left:t,top:e}=i.getBoundingClientRect();s={left:t,top:e,width:0,height:0}}return this.temporalRect&&Object.keys(this.temporalRect).forEach(t=>{var e=this.temporalRect[t],i="width"===t||"left"===t?this.rectScale.x:"height"===t||"top"===t?this.rectScale.y:1;this.el.style[t]=(e-s[t])*i+"px"}),this}_removeHandlers(){return this.handlers.forEach(t=>t.destroy()),delete this.handlers,this}}DDResizable._originStyleProp=["width","height","position","left","top","opacity","zIndex"];export{DDResizable};